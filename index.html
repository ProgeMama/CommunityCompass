<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Compass - Landing Page</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- ...existing code... -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff3b30;
            --secondary: #222831;
            --accent: #7b9e30;
            --bg: rgb(246, 246, 246);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-dark: rgba(34, 40, 49, 0.7);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            --radius: 22px;
        }

        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            min-height: 100vh;
            color: var(--secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 0;
            font-size: 1.25em; /* Increased from default */
        }

        .header {
            background: #169c79;
            color: #fff;
            padding: 1.5rem;
            text-align: center;
            border-radius: 0; /* Changed from var(--radius) to straight edges */
            box-shadow: var(--shadow);
            width: 100%; /* Full width of phone-inner */
            max-width: none;
            margin-bottom: 2rem;
            font-family: 'Source Code Pro', monospace;
            box-sizing: border-box;
            font-size: 1.25em; /* Added for larger header text */
        }

        .header h1 {
            font-size: 2.5rem; /* Increased from 2rem */
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
            font-size: 1.1em; /* Slightly larger */
        }

        /* Add: Make tab-bar and tab-icon-btns fill width */
        .tab-bar {
            display: flex;
            gap: 0.5em; /* Reduced from 1em */
            justify-content: center;
            width: 100%;
        }

        .tab-icon-btn {
            flex: 1 1 0;
            min-width: 0;
            width: 100%;
            max-width: 210px;
            height: 210px; /* Larger height for more space */
            aspect-ratio: 2 / 1;
            border-radius: 18px;
            background: linear-gradient(90deg, #e6e9f0, #eef1f5);
            border: 2px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2.1em; /* Increased from 1.7em */
            color: #003073;
            cursor: pointer;
            transition: background 0.2s, border 0.2s, color 0.2s;
            position: relative;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.08);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .tab-icon-btn span {
            color: #003073 !important;
            font-family: 'Open Sans', Arial, sans-serif !important;
            font-size: 0.6em !important; /* Reduced further */
        }

        .map-container {
            width: 100%;
            height: 320px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            z-index: 1;
        }

        .info-section {
            background: var(--glass);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem; /* Reduced from 1.5rem */
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            gap: 1.2rem; /* Reduced from 2rem */
            font-size: 1.1em; /* Slightly larger */
        }

        .public-announcements {
            border: 2.5px solid #ff3b30;   /* Red border */
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.2rem 1rem; /* Reduced from 1.5rem 1rem */
            margin: 0 0 0.7em 0;  /* Reduced bottom margin */
            display: flex;
            flex-direction: column;
        }

        .community-board {
            border: none;                   /* Remove red border */
            background: var(--glass);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-top: 1rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .public-announcements h2,
        .community-board h3 {
            color: #003073;
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem; /* Increased from 1.2rem */
        }

        .public-announcements h2 {
            border: 2.5px solid #ff3b30;   /* Red border */

            font-size: 1.5rem; /* Increased from 1.2rem */
        }

        .community-board h3 {
            font-size: 1.5rem; /* Increased from 1.2rem */
        }

        .news-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .news-item {
            padding: 0.8rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .news-item.official {
            /* Remove the red border */
            border-left: none;
            padding-left: 4.2em; /* Add space for the icon */
            position: relative;
        }
        .news-item.official::before {
            content: "⚡";
            color: #ff3b30;
            font-size: 2.0em;
            position: absolute;
            left: 0.4em;
            top: 0.5em;
            line-height: 1;
            font-weight: bold;
            pointer-events: none;
        }

        .news-item.expanded {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .news-item h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem; /* Increased from 1.1rem */
            color: var(--secondary);
        }

        .news-item p {
            margin: 0;
            font-size: 1.1rem; /* Increased from 0.9rem */
            color: #555;
            display: none;
        }

        .news-item.expanded p {
            display: block;
        }

        .news-item .date {
            font-size: 1rem; /* Increased from 0.8rem */
            color: #777;
        }

        .community-board {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--glass);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .community-board h3 {
            color: #7b9e30;
            margin-bottom: 0.5rem;
            font-size: 1.4em;
        }

        .community-board ul {
            list-style: none;
            padding: 0;
        }

        .community-board li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1em;
            font-size: 1.1em; /* Slightly larger */
        }

        .community-board li:last-child {
            border-bottom: none;
        }

        .community-board .reply-button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 1em;
            padding: 0.3em 0.8em;
            font-size: 1.1em; /* Increased from 0.9em */
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .community-board .reply-button:hover,
        .community-board .reply-button:focus {
            background: #bcf4f7;
            color: var(--accent);
        }

        /* Chat modal styles */
        .chat-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            right: 2vw;
            bottom: 2vw;
            width: 340px;
            max-width: 95vw;
            height: auto;
            background: none;
            justify-content: flex-end;
            align-items: flex-end;
            pointer-events: none;
        }

        .chat-modal.active {
            display: flex;
            pointer-events: auto;
        }

        .chat-modal .chat-content {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 420px;
            max-width: 95vw;
            min-height: 180px;
            max-height: 70vh;
            padding: 1.2em 1em 1em 1em;
            display: flex;
            flex-direction: column;
            gap: 1em;
            position: relative;
            transition: box-shadow 0.2s;
        }

        .chat-modal.minimized .chat-content {
            height: 2.5em;
            min-height: 0;
            max-height: 2.5em;
            overflow: hidden;
            padding: 0.5em 1em;
            cursor: pointer;
            gap: 0;
        }

        .chat-modal .chat-header {
            font-weight: bold;
            font-size: 1.3em; /* Increased from 1.1em */
            color: var(--primary);
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-modal .chat-messages {
            background: #f6eee7;
            border-radius: 0.7em;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.7em;
            font-size: 1.1em; /* Increased from 0.97em */
            color: #222;
        }

        .chat-modal.minimized .chat-messages,
        .chat-modal.minimized .chat-input-row {
            display: none;
        }

        .chat-modal .chat-input-row {
            display: flex;
            gap: 0.5em;
        }

        .chat-modal .chat-input-row input {
            flex: 1;
            padding: 0.5em;
            border-radius: 0.5em;
            border: 1px solid #ccc;
            font-size: 1.1em; /* Increased from 1em */
        }

        .chat-modal .chat-input-row button {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 0.5em;
            padding: 0.5em 1em;
            font-size: 1.1em; /* Increased from 1em */
            cursor: pointer;
        }

        .chat-modal .close-chat {
            font-size: 1.3em;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 0.5em;
        }

        .chat-modal .minimize-chat {
            font-size: 1.1em;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 0.5em;
        }


        @media (max-width: 600px) {
            .chat-modal,
            .chat-modal .chat-content {
                width: 98vw;
                min-width: 0;
                right: 0;
                left: 0;
                bottom: 0;
                border-radius: 0.7em 0.7em 0 0;
            }
        }

        @media (max-width: 1000px) {
            .container {
                padding: 0 0.3rem;
            }

            .map-container {
                height: 180px;
            }


        }

        @media (max-width: 900px) {
            .info-section {
                flex-direction: column;
                gap: 1.5rem;
            }
        }

        .public-announcements h2#public-news-header {
            cursor: pointer;
            width: auto;
            background: #fff;              /* White background */
            color: #ff3b30;                /* Red text */
            border-radius: var(--radius);
            padding: 0.3em 1.0em;
            margin-bottom: 0.30em;
            margin-left: -1rem;
            margin-right: -1rem;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 0.7em;
            transition: background 0.2s, color 0.2s;
            border: 0px solid #ff3b30;     /* Optional: add red border for emphasis */
        }

        .public-announcements h2#public-news-header:hover,
        .public-announcements h2#public-news-header.active {
            background: #ffeaea;           /* Light red background on hover/active */
            color: #ff3b30;
        }

        /* Change tab-icon-btn from circle to square with rounded edges */



        /* Ensure water API markers remain as water drops */
        /* This is handled in the JS:
           The icon for water API markers uses 💧 and a white circle background.
           No CSS change needed here, just keep the JS code that sets the icon as 💧 in a white circle.
        */

        #marker-filters {
            margin: 1em 0;
            text-align: center;
            background: #f6eee7;
            border-radius: 18px;
            box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.07);
            padding: 1.2em 0.8em;
            display: inline-block;
            width: 100%;
            max-width: 1200px;
        }

        #marker-filters label {
            display: inline-flex;
            align-items: center;
            gap: 0.4em;
            background: #fff;
            border-radius: 1.2em;
            padding: 0.25em 0.9em 0.25em 0.7em;
            margin: 0.2em 0.3em;
            font-size: 1.15em; /* Increased from 1em */
            color: #003073;
            box-shadow: 0 1px 4px 0 rgba(31, 38, 135, 0.06);
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
            border: 1px solid #e0e0e0;
        }

        #marker-filters label:hover,
        #marker-filters label:focus-within {
            background: #e6e9f0;
            color: #169c79;
        }

        #marker-filters input[type="checkbox"] {
            accent-color: #169c79;
            width: 1.1em;
            height: 1.1em;
            margin-right: 0.3em;
            border-radius: 0.3em;
            border: 1.5px solid #b0b0b0;
            outline: none;
            transition: border 0.15s;
        }

        #marker-filters strong {
            color: #003073;
            font-size: 1.18em; /* Increased from 1.08em */
            margin-right: 0.7em;
            font-family: 'Open Sans', Arial, sans-serif;
        }

        @media (max-width: 800px) {
            #marker-filters {
                padding: 0.7em 0.2em;
                font-size: 1.05em; /* Increased from 0.98em */
            }

            #marker-filters label {
                font-size: 1.05em; /* Increased from 0.98em */
                padding: 0.18em 0.7em 0.18em 0.5em;
            }
        }

        /* Phone frame styles */
        .phone-frame {
            background: #222831;
            border-radius: 38px;
            box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18), 0 1.5px 0 #fff inset;
            padding: 18px 8px 18px 8px;
            margin: 0 auto 2em auto;
            width: 75vw; /* Fill 3/4 of the viewport width */
            max-width: 1200px;
            min-width: 320px;
            position: relative;
            min-height: 740px;
            box-sizing: border-box;
        }
        .phone-notch {
            width: 120px;
            height: 18px;
            background: #111;
            border-radius: 0 0 18px 18px;
            margin: 0 auto 8px auto;
            position: relative;
            z-index: 2;
        }
        .phone-inner {
            background: var(--bg);
            border-radius: 30px;
            min-height: 700px;
            box-shadow: 0 2px 8px 0 rgba(31,38,135,0.08);
            padding-bottom: 2em;
            overflow: hidden;
            position: relative;
            width: 100%;
        }
        @media (max-width: 900px) {
            .phone-frame {
                width: 98vw;
                max-width: 100vw;
                min-width: 0;
                border-radius: 0;
                padding: 0;
            }
            .phone-inner {
                border-radius: 0;
                min-height: 0;
            }
            .phone-notch {
                display: none;
            }
        }
    </style>
</head>

<body>
<div class="phone-frame">
    <div class="phone-notch"></div>
    <div class="phone-inner">
    <div class="header">
        <h1><i class="fa-solid fa-shield-halved"></i> Community Compass</h1>
    </div>

    <!-- Tabs above public news -->
    <div class="container" style="margin-bottom: 3.0rem;">
        <div class="tab-bar" style="display: flex; gap: 0.5em; justify-content: center; margin-bottom: 0.5em; width: 100%;">
            <button class="tab-icon-btn" id="city-news-tab" title="City News">
                <img src="ajaleht.png" alt="Local news" style="width:2.2em; height:2.2em; margin-bottom:0.1em;" />
                <span style="margin-top:0.3em; font-size:0.3em; font-family:'Open Sans',sans-serif;">Local news</span>
            </button>
            <button class="tab-icon-btn" id="local-events-tab" title="Local Events & Establishments">
                <img src="ruupur.png" alt="Events & offers" style="width:2.2em; height:2.2em; margin-bottom:0.1em;" />
                <span style="margin-top:0.3em; font-size:0.3em; font-family:'Open Sans',sans-serif;">Events & offers</span>
            </button>
            <button class="tab-icon-btn" id="my-adverts-tab" title="My Adverts" style="position:relative;">
                <img src="ymbrik.png" alt="Messages" style="width:2.2em; height:2.2em; margin-bottom:0.1em;" />
                <span id="my-adverts-badge" class="notification-badge"
                    style="display:none; position:absolute; top:0.2em; right:0.2em; background:#ff3b30; color:#fff; border-radius:1em; font-size:0.8em; padding:0.1em 0.6em;">0</span>
                <span style="margin-top:0.3em; font-size:0.3em; font-family:'Open Sans',sans-serif;">Messages</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div class="info-section">
            <!-- Remove old community-board-buttons from here -->
            <div class="public-announcements">
                <h2 id="public-news-header">
                    <i class="fa-solid fa-triangle-exclamation" style="font-size:1.7em; color:#ff3b30; margin-right:0.2em; vertical-align:middle;"></i> Public Announcements                </h2>
                <div class="news-feed" id="news-feed">
                    <div class="news-item official expanded" style="border-left:4px solid #7b9e30;background:#f6fff0;">

                        <div class="date" style="color:#3a5022;">2025-06-01 • City Council</div>
                    </div>
                </div>
                <div id="news-dropdown" style="display:none;margin-top:0.5em;"></div>
            </div>
            <div class="community-board">
                <h3><i class="fa-solid fa-users"></i> Community Board</h3>
                <ul id="community-board-list">
                    <li>No posts or announcements available.</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-content">
            <div class="chat-header" id="chatHeader">
                <span>Chat</span>
                <span>
                    <button class="minimize-chat" id="minimizeChatBtn" title="Minimize">&#8211;</button>
                    <button class="close-chat" id="closeChatBtn" title="Close">&times;</button>
                </span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <form class="chat-input-row" id="chatForm">
                <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off" required />
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="map-container">
            <div id="map"></div>
            <span id="map-placeholder" style="display:none;">Interactive Map Placeholder (Mapbox/Google Maps)</span>
        </div>

        <div id="marker-filters" style="margin: 1em 0; text-align:center;">
        <div style="display:inline-block; margin-right:2em;">
            <strong>Public resources:</strong>
            <label><input type="checkbox" class="filter-checkbox" value="water" checked> 💧 Water</label>
            <label><input type="checkbox" class="filter-checkbox" value="aed" checked> ❤️ AED</label>
            <label><input type="checkbox" class="filter-checkbox" value="atm" checked> 🏧 ATM</label>
            <label><input type="checkbox" class="filter-checkbox" value="medical" checked> 🏥 Medical</label>
            <label><input type="checkbox" class="filter-checkbox" value="fuel" checked> ⛽ Fuel</label>
            <label><input type="checkbox" class="filter-checkbox" value="Playgrounds" checked>  Playgrounds</label>

        </div>
        <div style="display:inline-block;">
            <strong>Community resources:</strong>
            <label><input type="checkbox" class="filter-checkbox" value="Food" checked> 🍏 Food</label>
            <label><input type="checkbox" class="filter-checkbox" value="Car" checked> 🚗 Car</label>
            <label><input type="checkbox" class="filter-checkbox" value="Pet" checked> 🐕 Pet</label>
            <label><input type="checkbox" class="filter-checkbox" value="Other" checked>🛟 Other</label>
        </div>
        </div>

    </div>

    <!-- Add this modal just before the closing </body> tag -->
    <div id="addMarkerModal" class="modal" style="display:none;">
        <div class="modal-content">
        <span class="close" id="closeAddMarkerModal">&times;</span>
        <h3>Add Resource</h3>
        <form id="addMarkerForm">
        <label>Type:
            <select id="markerType" required>
            <option value="Water">💧 Water</option>
            <option value="AED">❤️ AED</option>
            <option value="Fruit">🍏 fruit</option>
            <option value="Dog walking">🐕 Looking dog walkers</option>
            </select>
        </label><br><br>
        <label>Comment:<br>
            <input type="text" id="markerComment" maxlength="100" placeholder="Optional comment">
        </label><br><br>
        <label>Photo URL:<br>
            <input type="url" id="markerPhoto" placeholder="http://...">
        </label><br><br>
        <input type="hidden" id="markerLat">
        <input type="hidden" id="markerLng">
        <button type="submit" class="submit-btn">Add Marker</button>
        </form>
    </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    // Ensure only one map instance and avoid double initialization
    let map;
    let allMarkers = [];
    let tempMarker = null;

    // Store API markers separately to ensure they are always present
    let apiMarkers = [];

    function fixMapSize() {
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Remove any previous map instance if present (for hot reload/dev)
        if (window._leafletMap && window._leafletMap.remove) {
            window._leafletMap.remove();
            window._leafletMap = null;
        }
        // Ensure #map is empty
        document.getElementById('map').innerHTML = '';

        // Initialize the map with a 10 km radius view (approx. zoom level 12)
        map = L.map('map', { zoomControl: true, attributionControl: true }).setView([39.457, -0.40], 14);
        window._leafletMap = map; // for compatibility with other code

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        fixMapSize();
        window.addEventListener('resize', fixMapSize);
        document.addEventListener('visibilitychange', fixMapSize);

        // Fetch locations from API and add to map
        fetch('https://valencia.opendatasoft.com/api/explore/v2.1/catalog/datasets/fonts-daigua-publica-fuentes-de-agua-publica/records?limit=20')
            .then(response => response.json())
            .then(data => {
                if (data && data.results) {
                    data.results.forEach(item => {
                        if (item.geo_point_2d && item.geo_point_2d.lat && item.geo_point_2d.lon) {
                            const markerData = {
                                lat: item.geo_point_2d.lat,
                                lng: item.geo_point_2d.lon,
                                type: 'water',
                                comment: item.calle,
                                thumbs: 0,
                                foto: item.foto
                            };
                            // Use same white circle background for water API markers
                            const icon = L.divIcon({
                                className: "custom-icon",
                                html: `<span style="
                                    display:inline-flex;
                                    align-items:center;
                                    justify-content:center;
                                    width:40px;
                                    height:40px;
                                    border-radius:50%;
                                    background:#fff;
                                    box-shadow:0 2px 8px rgba(0,0,0,0.10);
                                    font-size:28px;
                                    line-height:1;
                                    border:2px solid #eee;
                                ">💧</span>`,
                                iconSize: [48, 48],
                                iconAnchor: [24, 24],
                            });
                            const label = markerData.comment || "Water";
                            const html = `
                                <div class="popup">
                                <strong>${label}</strong><br>
                                <span style="font-size:1.2em;">💧</span>
                                </div>`;
                            const marker = L.marker([markerData.lat, markerData.lng], { icon }).addTo(map);
                            marker.bindPopup(html);
                            // Add to both allMarkers and apiMarkers for filtering
                            const markerObj = { marker, type: markerData.type, isApi: true };
                            allMarkers.push(markerObj);
                            apiMarkers.push(markerObj);
                        }
                    });
                }
            })
            .catch(err => {
                console.error('Failed to load locations:', err);
            });

        // On map click: prompt for water/AED
        map.on('click', function(e) {
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            tempMarker = L.marker(e.latlng).addTo(map);

            const popupHtml = `
                <div>
                    <strong>Add Resource</strong><br>
                    <button id="publicBtn">Public</button>
                    <button id="privateBtn">Private</button>
                </div>
            `;
            tempMarker.bindPopup(popupHtml).openPopup();

            setTimeout(() => {
                const publicBtn = document.getElementById('publicBtn');
                const privateBtn = document.getElementById('privateBtn');
                if (publicBtn) {
                    publicBtn.onclick = (ev) => {
                        L.DomEvent.stopPropagation(ev);
                        ev.stopPropagation();
                        showTypeSelection(tempMarker.getLatLng(), 'Public');
                    };
                }
                if (privateBtn) {
                    privateBtn.onclick = (ev) => {
                        L.DomEvent.stopPropagation(ev);
                        ev.stopPropagation();
                        showTypeSelection(tempMarker.getLatLng(), 'Community');
                    };
                }
            }, 100);
        });

        // Sample news data
        const startDate = new Date('2025-05-26');
        const endDate = new Date('2025-08-08');



        // Sample public resource markers (1-2 for each type)
        const samplePublicMarkers = [
            // AED
            { lat: 39.458, lng: -0.405, type: "aed", comment: "AED at Sports Center", thumbs: 0, foto: "", icon: "❤️" },
            { lat: 39.459, lng: -0.40, type: "aed", comment: "Defibrillator at Sunrise Bakery", thumbs: 0, foto: "", icon: "❤️" },
    
            // Fuel
            { lat: 39.456, lng: -0.406, type: "fuel", comment: "Fuel Station", thumbs: 0, foto: "", icon: "⛽" },
            // Playgrounds
            { lat: 39.458, lng: -0.409, type: "playgrounds", comment: "Children's Playground", thumbs: 2, foto: "", icon: "🏖️" },
        ];

        // Add sample public resource markers to the map and allMarkers
        samplePublicMarkers.forEach(data => {
            const icon = L.divIcon({
                className: "custom-icon",
                html: `<span style="
                    display:inline-flex;
                    align-items:center;
                    justify-content:center;
                    width:40px;
                    height:40px;
                    border-radius:50%;
                    background:#fff;
                    box-shadow:0 2px 8px rgba(0,0,0,0.10);
                    font-size:28px;
                    line-height:1;
                    border:2px solid #eee;
                ">${data.icon}</span>`,
                iconSize: [48, 48],
                iconAnchor: [24, 24],
            });
            const label = data.comment || data.type;
            const html = `
                <div class="popup">
                <strong>${label}</strong><br>
                <span style="font-size:1.2em;">${data.icon}</span>
                </div>`;
            const marker = L.marker([data.lat, data.lng], { icon }).addTo(map);
            marker.bindPopup(html);
            // Add to allMarkers with type for filtering
            allMarkers.push({ marker, type: data.type });
        });

        // Filtering logic
        document.querySelectorAll('.filter-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const enabledTypes = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value.toLowerCase());
                // Always keep API water markers if "water" is checked
                allMarkers.forEach(obj => {
                    if (obj.isApi && obj.type === "water") {
                        if (enabledTypes.includes("water")) {
                            map.addLayer(obj.marker);
                        } else {
                            map.removeLayer(obj.marker);
                        }
                    } else {
                        if (enabledTypes.includes(obj.type)) {
                            map.addLayer(obj.marker);
                        } else {
                            map.removeLayer(obj.marker);
                        }
                    }
                });
            });
        });
    });

    function addMarker(data, save) {
        const type = (data.type || '').toLowerCase();
        const icon = L.divIcon({
            className: "custom-icon",
            html: `<span style="font-size:18px;line-height:1;">${
                type === "water" ? "💧"
                : type === "aed" ? "❤️"
                : type === "atm" ? "🏧"
                : type === "medical" ? "🏥"
                : type === "fuel" ? "⛽"
                : type === "fruit" ? "🍏"
                : type === "car" ? "🚗"
                : type === "pet" ? "🐕"
                : type === "other" ? "🛟"
                : type === "playgrounds" ? "🛝"
                : "❓"
            }</span>`,
            iconSize: [48, 48],
            iconAnchor: [24, 24],
        });

        const label = type === "water" ? "💧 Water Source"
            : type === "aed" ? "❤️ AED"
            : type === "atm" ? "🏧 ATM"
            : type === "medical" ? "🏥 Medical"
            : type === "fuel" ? "⛽ Fuel"
            : type === "fruit" ? "🍏 Food"
            : type === "car" ? "🚗 Car"
            : type === "pet" ? "🐕 Dog walking"
            : type === "other" ? "🛟 Other"
            : "❓";

        let needGive = "";
        if (data.need || data.give) {
            needGive += `<div>`;
            if (data.need) needGive += `<span style="color:#ff3b30;">🟧 Need</span><br>`;
            if (data.give) needGive += `<span style="color:#00adb5;">🟩 Give</span><br>`;
            needGive += `</div>`;
        }

        const id = `${data.lat},${data.lng}`;
        const isCommunity = ["fruit", "car", "pet", "other"].includes(type);

        const chatBtn = isCommunity
            ? `<button class="user-type-btn" style="margin-top:8px;" onclick="startChat('${id}')">💬 Start Chat</button>`
            : "";

        const html = `
            <div class="popup">
            <strong>${label}</strong><br>
            ${needGive}
            ${data.comment || "<i>No comment</i>"}<br>
            ${data.foto ? `<img src="${data.foto}" alt="Photo" style="max-width:120px;"><br>` : ""}
            <button class="user-type-btn" style="margin-top:8px;" onclick="thumb('${id}')">👍 Thumbs up <span id="thumbs-${id}">${data.thumbs}</span></button>
            ${chatBtn}
            </div>`;

        const marker = L.marker([data.lat, data.lng], { icon }).addTo(map);
        marker.bindPopup(html);

        allMarkers.push({ marker, type });
        if (save) {
            stored.push(data);
            localStorage.setItem("markers", JSON.stringify(stored));
        }
    }

    function thumb(id) {
        const markerObj = allMarkers.find(obj => `${obj.marker.getLatLng().lat},${obj.marker.getLatLng().lng}` === id);
        if (markerObj) {
            if (!markerObj.marker._thumbs) markerObj.marker._thumbs = 0;
            markerObj.marker._thumbs++;
            const el = document.getElementById('thumbs-' + id);
            if (el) el.textContent = markerObj.marker._thumbs;
        }
    }

    function startChat(id) {
        alert("Chat feature coming soon for marker: " + id);
    }
    // --- Community Board Animated Reveal Logic ---
    let revealedCommunityBoard = [];
    let revealIndex = 0;
    let communityBoardInterval;

    // Add CSS animation for new community items only once
    if (!document.getElementById('communityBoardAnimationKeyframes')) {
        const style = document.createElement('style');
        style.id = 'communityBoardAnimationKeyframes';
        style.innerHTML = `
        @keyframes communityItemFadeIn {
            0% {
                opacity: 0;
                transform: translateY(-30px) scale(0.98);
            }
            60% {
                opacity: 1;
                transform: translateY(8px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .community-item-new {
            animation: communityItemFadeIn 0.7s cubic-bezier(.23,1.02,.53,.97);
            background: #fffbe7;
            box-shadow: 0 2px 12px 0 rgba(255, 200, 0, 0.09);
            z-index: 1;
        }
        `;
        document.head.appendChild(style);
    }

    function renderCommunityBoardAnimated(newItemIndex = null) {
        const boardList = document.getElementById('community-board-list');
        boardList.innerHTML = '';

        if (revealedCommunityBoard.length === 0) {
            boardList.innerHTML = '<li>No posts or announcements available.</li>';
            return;
        }

        revealedCommunityBoard.forEach((item, index) => {
            const listItem = document.createElement('li');
            let meta = item.date;
            if (item.author) meta += ' • ' + item.author;
            listItem.innerHTML = `
                <div>
                    <strong>${item.title}</strong><br>
                    <span style="font-size:0.95em;color:#555;">${item.content}</span><br>
                    <span class="date" style="font-size:0.85em;color:#888;">${meta}</span>
                </div>
                ${item.type !== 'announcement' ? '<button class="reply-button">Reply</button>' : ''}
            `;
            // Animate only the newest item just added (index 0)
            if (newItemIndex !== null && index === newItemIndex) {
                listItem.classList.add('community-item-new');
                listItem.addEventListener('animationend', () => {
                    listItem.classList.remove('community-item-new');
                }, { once: true });
            }
            boardList.appendChild(listItem);
        });

        attachReplyChatHandlers();
    }

    function revealNextCommunityAnnouncementAnimated() {
        if (revealIndex < sampleCommunityBoard.length) {
            revealedCommunityBoard.unshift(sampleCommunityBoard[revealIndex]);
            renderCommunityBoardAnimated(0); // Animate the new top item
            revealIndex++;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ...existing code...
        // Start with no messages revealed
        revealedCommunityBoard = [];
        renderCommunityBoardAnimated();
        revealIndex = 0;
        communityBoardInterval = setInterval(revealNextCommunityAnnouncementAnimated, 10000);
        // ...existing code...
    });
    </script>

    <script>

    // Close modal
    document.getElementById('closeAddMarkerModal').onclick = function() {
        document.getElementById('addMarkerModal').style.display = 'none';
    };

    // Handle form submit
    document.getElementById('addMarkerForm').onsubmit = function(ev) {
        ev.preventDefault();
        const lat = parseFloat(document.getElementById('markerLat').value);
        const lng = parseFloat(document.getElementById('markerLng').value);
        const type = document.getElementById('markerType').value;
        const comment = document.getElementById('markerComment').value;
        const foto = document.getElementById('markerPhoto').value;
        const marker = { lat, lng, type, comment, thumbs: 0, foto };
        addMarker(marker, true);
        document.getElementById('addMarkerModal').style.display = 'none';
        document.getElementById('addMarkerForm').reset();
    };

    // Optional: close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('addMarkerModal')) {
            document.getElementById('addMarkerModal').style.display = "none";
        }
    };
</script>

    <script>
        // Filtering logic
        document.querySelectorAll('.filter-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const enabledTypes = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                allMarkers.forEach(obj => {
                    if (enabledTypes.includes(obj.type)) {
                        map.addLayer(obj.marker);
                    } else {
                        map.removeLayer(obj.marker);
                    }
                });
            });
        });
    </script>
    <script>
    function showTypeSelection(latlng, accessType) {
        const publicIcons = [
            { type: 'water', icon: '💧' },
            { type: 'aed', icon: '❤️' },
            { type: 'atm', icon: '🏧' },
            { type: 'medical', icon: '🏥' },
            { type: 'fuel', icon: '⛽' }
        ];
        const communityIcons = [
            { type: 'fruit', icon: '🍏' },
            { type: 'car', icon: '🚗' },
            { type: 'pet', icon: '🐕' },
            { type: 'other', icon: '🛟' }
        ];
        const icons = accessType.toLowerCase() === 'public' ? publicIcons : communityIcons;

        let html = `<div id="popup-content"><strong>Select Resource Type</strong><br>`;
        icons.forEach(i => {
            html += `<button class="icon-btn" data-type="${i.type}" type="button">${i.icon}</button> `;
        });
        html += `</div>`;

        if (tempMarker) {
            tempMarker.setPopupContent(html).openPopup();
        }

        setTimeout(() => {
            // Use event delegation to ensure the buttons are clickable
            const popupContent = document.getElementById('popup-content');
            if (popupContent) {
                popupContent.addEventListener('mousedown', function(e) {
                    L.DomEvent.stopPropagation(e);
                });
                popupContent.addEventListener('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    const btn = e.target.closest('.icon-btn');
                    if (btn && btn.dataset.type) {
                        showCommentForm(latlng, accessType, btn.dataset.type);
                    }
                });
            }
        }, 100);
    }

    function showCommentForm(latlng, accessType, type) {
        const isCommunity = accessType.toLowerCase() === 'community';
        const checkboxes = isCommunity ? `
            <label><input type="checkbox" id="needBox"> Need</label>
            <label><input type="checkbox" id="giveBox"> Give</label><br>
        ` : '';

        const html = `
            <div>
                <strong>Add Details</strong><br>
                ${checkboxes}
                <input type="text" id="markerComment" placeholder="Optional comment"><br>
                <input type="url" id="markerPhoto" placeholder="Photo URL"><br>
                <button id="addMarkerBtn" type="button">Add Marker</button>
            </div>
        `;
        if (tempMarker) {
            tempMarker.setPopupContent(html).openPopup();
        }

        setTimeout(() => {
            const addBtn = document.getElementById('addMarkerBtn');
            if (addBtn) {
                addBtn.onclick = () => {
                    const comment = document.getElementById('markerComment').value;
                    const foto = document.getElementById('markerPhoto').value;
                    let need = false, give = false;
                    if (isCommunity) {
                        need = document.getElementById('needBox').checked;
                        give = document.getElementById('giveBox').checked;
                    }
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }
                    const marker = {
                        lat: latlng.lat,
                        lng: latlng.lng,
                        type: type.toLowerCase(),
                        comment,
                        thumbs: 0,
                        foto,
                        access: accessType,
                        need,
                        give
                    };
                    addMarker(marker, true);
                };
            }
        }, 100);
    }
    // ...existing code...
</script>

    <script>
        // Date range for news
        const startDate = new Date('2025-05-26');
        const endDate = new Date('2025-08-08');

        // 7 official news items in English
        const sampleNews = [
            {
                title: "  Power Outage in the City",
                content: "A major power outage is affecting several districts. Crews are working to restore electricity. Please stay tuned for updates and avoid using elevators until power is restored.",
                date: "2025-06-01",
                source: "City Council",
                official: true
            }
        ];

        // Sample public resource markers (1-2 for each type)
        const samplePublicMarkers = [
            // Water
            { lat: 39.47, lng: -0.38, type: "water", comment: "Water Fountain at Central Park", thumbs: 2, foto: "", icon: "💧" },
            { lat: 39.472, lng: -0.382, type: "water", comment: "Drinking Tap near Library", thumbs: 1, foto: "", icon: "🚰" },
            // AED
            { lat: 39.468, lng: -0.385, type: "aed", comment: "AED at Sports Center", thumbs: 0, foto: "", icon: "❤️" },
            { lat: 39.469, lng: -0.39, type: "aed", comment: "Defibrillator at Mall Entrance", thumbs: 0, foto: "", icon: "⚡" },
            // ATM
            { lat: 39.471, lng: -0.384, type: "atm", comment: "ATM at Main Square", thumbs: 3, foto: "", icon: "🏧" },
            { lat: 39.473, lng: -0.387, type: "atm", comment: "Cash Machine at Supermarket", thumbs: 1, foto: "", icon: "💵" },
            // Medical
            { lat: 39.474, lng: -0.381, type: "medical", comment: "24h Clinic", thumbs: 2, foto: "", icon: "🏥" },
            { lat: 39.475, lng: -0.383, type: "medical", comment: "Pharmacy", thumbs: 1, foto: "", icon: "💊" },
            // Fuel
            { lat: 39.476, lng: -0.386, type: "fuel", comment: "Fuel Station", thumbs: 0, foto: "", icon: "⛽" },
            { lat: 39.477, lng: -0.388, type: "fuel", comment: "EV Charger", thumbs: 0, foto: "", icon: "🔌" },
            // Playgrounds
            { lat: 39.478, lng: -0.389, type: "playgrounds", comment: "Children's Playground", thumbs: 2, foto: "", icon: "🛝" },
            { lat: 39.479, lng: -0.39, type: "playgrounds", comment: "Sandbox Area", thumbs: 1, foto: "", icon: "🏖️" }
        ];

        // Sample cooperative news and community posts (merged)
        const sampleCommunityBoard = [
            {
                title: "Ice Cream Melting! 🍦",
                content: "Power's out and my freezer is down. Anyone want to come over for an ice cream party before it all melts? Apt 4C.",
                date: "2025-06-01",
                type: "give",
                author: "Maria"
            },
            {
                title: "Where's the nearest public water tap?",
                content: "Does anyone know where I can refill water bottles nearby? No water at home.",
                date: "2025-06-01",
                type: "need",
                author: "Alex"
            },
            {
                title: "Check the Community Map",
                content: "You can find public water taps and other resources on the community map below.",
                date: "2025-06-01",
                type: "info",
                author: "Sophie"
            },
            {
                title: "Elevator Out of Service",
                content: "Reminder: Please avoid using the elevator during the outage. Use stairs for safety.",
                date: "2025-06-01",
                type: "announcement",
                author: "Building Management"
            },
            {
                title: "Phone Charging Station",
                content: "I have a power bank and solar charger available in Apt 2A if anyone needs to charge their phone.",
                date: "2025-06-01",
                type: "offer",
                author: "Liam"
            },
            {
                title: "Candle Swap",
                content: "I have extra candles and matches if anyone needs some. Happy to trade for snacks!",
                date: "2025-06-01",
                type: "offer",
                author: "Nina"
            },
            {
                title: "Stay Cool",
                content: "Keep windows open for ventilation and check on elderly neighbors. Let’s help each other out!",
                date: "2025-06-01",
                type: "info",
                author: "Building Management"
            }
        ];

        // Function to check if a date is within the specified range
        function isDateInRange(dateString, startDate, endDate) {
            const date = new Date(dateString);
            return date >= startDate && date <= endDate;
        }

        // Function to load news
        function loadNews() {
            const newsFeed = document.getElementById('news-feed');
            const newsDropdown = document.getElementById('news-dropdown');
            newsFeed.innerHTML = '';

            // Sort by date (newest first)
            const sortedNews = sampleNews
                .filter(item => isDateInRange(item.date, startDate, endDate))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedNews.length === 0) {
                newsFeed.innerHTML = '<div class="news-item"><h3>No announcements</h3></div>';
                newsDropdown.style.display = 'none';
                return;
            }

            // Show only the first announcement
            const first = sortedNews[0];
            const firstNewsItem = document.createElement('div');
            firstNewsItem.className = `news-item ${first.official ? 'official' : ''}`;
            firstNewsItem.innerHTML = `
                <h3>${first.title}</h3>
                <p>${first.content}</p>
                <div class="date">${first.date} • ${first.source}</div>
            `;
            firstNewsItem.addEventListener('click', function () {
                this.classList.toggle('expanded');
            });
            newsFeed.appendChild(firstNewsItem);

            // If more, prepare the rest but don't show button
            if (sortedNews.length > 1) {
                newsDropdown.style.display = 'none';
                newsDropdown.innerHTML = '';
                for (let i = 1; i < sortedNews.length; ++i) {
                    const item = sortedNews[i];
                    const newsItem = document.createElement('div');
                    newsItem.className = `news-item ${item.official ? 'official' : ''}`;
                    newsItem.innerHTML = `
                        <h3>${item.title}</h3>
                        <p>${item.content}</p>
                        <div class="date">${item.date} • ${item.source}</div>
                    `;
                    newsItem.addEventListener('click', function () {
                        this.classList.toggle('expanded');
                    });
                    newsDropdown.appendChild(newsItem);
                }
            } else {
                newsDropdown.style.display = 'none';
            }
        }

        // Function to load community board (merged cooperative news and posts)

        // Example: Set this to the number of new messages for "My Adverts"
        let myAdvertsMessages = 2; // Set to 0 for no badge

        function updateMyAdvertsBadge() {
            const badge = document.getElementById('my-adverts-badge');
            if (myAdvertsMessages > 0) {
                badge.textContent = myAdvertsMessages;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadNews();
            loadCommunityBoard();
            updateMyAdvertsBadge();

            // Change: open a new page on header click
            const header = document.getElementById('public-news-header');
            header.onclick = function () {
                window.location.href = 'public-news.html';
            };
            header.onmouseenter = function () {
                header.classList.add('active');
            };
            header.onmouseleave = function () {
                header.classList.remove('active');
            };

            // Tab click handlers
            document.getElementById('city-news-tab').addEventListener('click', function (event) {
                event.preventDefault();
                alert('Navigating to "City News" (not implemented yet)');
            });
            document.getElementById('local-events-tab').addEventListener('click', function (event) {
                event.preventDefault();
                window.location.href = 'full-view.html';
            });
            document.getElementById('my-adverts-tab').addEventListener('click', function (event) {
                event.preventDefault();
                alert('Navigating to "My Adverts" (not implemented yet)');
            });

            // Make minimize and close functional for the chatbox
            document.getElementById('closeChatBtn').onclick = function () {
                document.getElementById('chatModal').classList.remove('active', 'minimized');
            };
            document.getElementById('minimizeChatBtn').onclick = function (e) {
                e.stopPropagation();
                const chatModal = document.getElementById('chatModal');
                chatModal.classList.toggle('minimized');
            };
            document.getElementById('chatHeader').onclick = function () {
                const chatModal = document.getElementById('chatModal');
                if (chatModal.classList.contains('minimized')) {
                    chatModal.classList.remove('minimized');
                }
            };
            window.addEventListener('keydown', function (e) {
                if (e.key === "Escape") document.getElementById('chatModal').classList.remove('active', 'minimized');
            });
        });

        // Navigation
        document.getElementById('resources-card').onclick = () => {
            window.location.href = 'full-view.html';
        };

        // My Announcements button
        // document.querySelector('.community-board .my-announcements-button').addEventListener('click', function (event) {
        //     event.preventDefault();
        //     alert('Navigating to "My Announcements" page (not implemented yet)');
        // });

        // Add handlers for the new buttons
        document.getElementById('city-news-btn').addEventListener('click', function (event) {
            event.preventDefault();
            alert('Navigating to "City News" (not implemented yet)');
        });
        document.getElementById('paid-adverts-btn').addEventListener('click', function (event) {
            event.preventDefault();
            alert('Navigating to "Paid Adverts" (not implemented yet)');
        });
        document.getElementById('my-adverts-btn').addEventListener('click', function (event) {
            event.preventDefault();
            alert('Navigating to "My Adverts" (not implemented yet)');
        });

        // Simple in-memory chat store for demo (keyed by post title)
        const chatStore = {};

        // Open chat modal for a given post
        function openChat(postTitle, recipient) {
            const chatModal = document.getElementById('chatModal');
            const chatHeader = document.getElementById('chatHeader');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            chatHeader.querySelector('span').textContent = postTitle;
            chatModal.classList.add('active');
            chatModal.classList.remove('minimized');
            chatInput.value = '';
            chatInput.focus();

            // Load messages
            const key = postTitle;
            chatMessages.innerHTML = '';
            if (chatStore[key]) {
                chatStore[key].forEach(msg => {
                    const div = document.createElement('div');
                    div.textContent = msg;
                    chatMessages.appendChild(div);
                });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Attach send handler (functional message sending)
            const chatForm = document.getElementById('chatForm');
            chatForm.onsubmit = function (ev) {
                ev.preventDefault();
                const val = chatInput.value.trim();
                if (!val) return;
                if (!chatStore[key]) chatStore[key] = [];
                chatStore[key].push("You: " + val);
                // Show the new message immediately
                chatMessages.innerHTML = '';
                chatStore[key].forEach(msg => {
                    const div = document.createElement('div');
                    div.textContent = msg;
                    chatMessages.appendChild(div);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
                chatInput.value = '';
                chatInput.focus();
                // Simulate reply
                setTimeout(() => {
                    chatStore[key].push((recipient ? recipient : "Other") + ": " + "Thanks for your message!");
                    if (chatModal.classList.contains('active') && !chatModal.classList.contains('minimized')) {
                        chatMessages.innerHTML = '';
                        chatStore[key].forEach(msg => {
                            const div = document.createElement('div');
                            div.textContent = msg;
                            chatMessages.appendChild(div);
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 800);
            };
            function renderChatMessages() {
                chatMessages.innerHTML = '';
                chatStore[key].forEach(msg => {
                    const div = document.createElement('div');
                    div.textContent = msg;
                    chatMessages.appendChild(div);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Close chat modal
        document.getElementById('closeChatBtn').onclick = function () {
            document.getElementById('chatModal').classList.remove('active', 'minimized');
        };
        // Minimize chat modal
        document.getElementById('minimizeChatBtn').onclick = function (e) {
            e.stopPropagation();
            const chatModal = document.getElementById('chatModal');
            chatModal.classList.toggle('minimized');
        };
        // Restore chat modal on header click if minimized
        document.getElementById('chatHeader').onclick = function () {
            const chatModal = document.getElementById('chatModal');
            if (chatModal.classList.contains('minimized')) {
                chatModal.classList.remove('minimized');
            }
        };
        window.addEventListener('keydown', function (e) {
            if (e.key === "Escape") document.getElementById('chatModal').classList.remove('active', 'minimized');
        });

        // Attach chat popup to reply buttons after community board is loaded
        function attachReplyChatHandlers() {
            document.querySelectorAll('.community-board .reply-button').forEach(btn => {
                btn.onclick = function () {
                    const li = btn.closest('li');
                    const title = li ? li.querySelector('strong')?.textContent || 'Post' : 'Post';
                    const author = li ? (li.querySelector('.date')?.textContent.split('•')[1] || '').trim() : '';
                    openChat(title, author);
                };
            });
        }

        // Initialize Leaflet map if element exists
        if (document.getElementById('map')) {
            // Prevent double initialization
            if (!window._leafletMap) {
                window._leafletMap = L.map('map', {
                    zoomControl: true,
                    attributionControl: true
                }).setView([39.47, -0.38], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(window._leafletMap);

                // Fix for map tiles splitting: force size after short delay and on tab visibility
                setTimeout(() => window._leafletMap.invalidateSize(), 400);
                window.addEventListener('resize', () => {
                    setTimeout(() => window._leafletMap.invalidateSize(), 100);
                });
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden && window._leafletMap) {
                        setTimeout(() => window._leafletMap.invalidateSize(), 100);
                    }
                });
            } else {
                setTimeout(() => window._leafletMap.invalidateSize(), 200);
            }
        }
        // After initializing the map
        if (window._leafletMap) {
            setTimeout(() => window._leafletMap.invalidateSize(), 200);
        }
    </script>

    </div>
</div>

</body>

</html>